<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ–‡ä»¶ç±»å‹æ·±åº¦åˆ†æå·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #252526;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        h1 {
            color: #569cd6;
            border-bottom: 2px solid #569cd6;
            padding-bottom: 10px;
        }
        .panel {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            margin: 15px 0;
            padding: 15px;
        }
        .panel-title {
            color: #569cd6;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        input[type="file"] {
            background: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #569cd6;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            margin: 10px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        button:hover {
            background: #005a9e;
        }
        button.danger {
            background: #d14d4d;
        }
        button.danger:hover {
            background: #a83c3c;
        }
        .log-output {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        .log-entry {
            margin: 2px 0;
            padding: 3px 0;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-warning { color: #d7ba7d; }
        .log-info { color: #9cdcfe; }
        .log-debug { color: #c586c0; }
        .hex-view {
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .detail-card {
            background: #2d2d30;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 15px;
        }
        .detail-title {
            color: #569cd6;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .detail-content {
            color: #d4d4d4;
            font-size: 14px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #4ec9b0; }
        .status-error { background: #f48771; }
        .status-warning { background: #d7ba7d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ PDFæ–‡ä»¶ç±»å‹æ·±åº¦åˆ†æå·¥å…·</h1>
        
        <div class="panel">
            <div class="panel-title">ğŸ“¤ æ–‡ä»¶ä¸Šä¼ åˆ†æ</div>
            <input type="file" id="fileInput" accept=".pdf" multiple>
            <div>
                <button onclick="analyzeSelectedFiles()">ğŸ” åˆ†æé€‰ä¸­æ–‡ä»¶</button>
                <button onclick="simulateServerResponse()">ğŸŒ æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”</button>
                <button class="danger" onclick="clearAllLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ—¥å¿—</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“Š åˆ†æç»“æœ</div>
            <div class="file-details" id="fileDetails"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“ è¯¦ç»†æ—¥å¿—</div>
            <div class="log-output" id="logOutput"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let analyzedFiles = [];

        // æ—¥å¿—ç³»ç»Ÿ
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toISOString().slice(11, 23);
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearAllLogs() {
            document.getElementById('logOutput').innerHTML = '';
            document.getElementById('fileDetails').innerHTML = '';
            analyzedFiles = [];
            log('æ‰€æœ‰æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ–‡ä»¶åˆ†æä¸»å‡½æ•°
        async function analyzeSelectedFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                log('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶', 'error');
                return;
            }

            log(`å¼€å§‹åˆ†æ ${files.length} ä¸ªæ–‡ä»¶...`, 'info');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                log(`--- åˆ†ææ–‡ä»¶ ${i + 1}/${files.length}: ${file.name} ---`, 'info');
                
                try {
                    const analysis = await analyzeFile(file);
                    analyzedFiles.push(analysis);
                    displayFileAnalysis(analysis);
                } catch (error) {
                    log(`æ–‡ä»¶ ${file.name} åˆ†æå¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            log('æ–‡ä»¶åˆ†æå®Œæˆ', 'success');
        }

        // æ–‡ä»¶è¯¦ç»†åˆ†æ
        async function analyzeFile(file) {
            const analysis = {
                name: file.name,
                size: file.size,
                mimeType: file.type,
                lastModified: new Date(file.lastModified),
                hexHeader: '',
                contentPreview: '',
                isPdfByHeader: false,
                isPdfByExtension: false,
                serverSimulation: {}
            };

            // åŸºæœ¬ä¿¡æ¯
            log(`æ–‡ä»¶å: ${analysis.name}`, 'info');
            log(`æ–‡ä»¶å¤§å°: ${(analysis.size / 1024).toFixed(2)} KB`, 'info');
            log(`MIMEç±»å‹: ${analysis.mimeType || 'æœªæŒ‡å®š'}`, 'info');
            log(`æœ€åä¿®æ”¹: ${analysis.lastModified.toLocaleString()}`, 'info');

            // æ‰©å±•åæ£€æŸ¥
            analysis.isPdfByExtension = file.name.toLowerCase().endsWith('.pdf');
            log(`æ‰©å±•åæ£€æŸ¥: ${analysis.isPdfByExtension ? 'âœ“ æ˜¯PDF' : 'âœ— ä¸æ˜¯PDF'}`, 
                analysis.isPdfByExtension ? 'success' : 'warning');

            // è¯»å–æ–‡ä»¶å†…å®¹è¿›è¡Œæ·±åº¦åˆ†æ
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            // åå…­è¿›åˆ¶å¤´éƒ¨æ˜¾ç¤º
            analysis.hexHeader = getHexHeader(uint8Array, 32);
            log(`æ–‡ä»¶å¤´éƒ¨åå…­è¿›åˆ¶: ${analysis.hexHeader}`, 'debug');

            // ASCIIé¢„è§ˆ
            analysis.contentPreview = getAsciiPreview(uint8Array, 100);
            log(`å†…å®¹é¢„è§ˆ: ${analysis.contentPreview}`, 'debug');

            // PDFå¤´éƒ¨æ£€æŸ¥
            analysis.isPdfByHeader = checkPdfHeader(uint8Array);
            const pdfStatus = analysis.isPdfByHeader ? 'âœ“ æ˜¯PDF' : 'âœ— ä¸æ˜¯PDF';
            const pdfColor = analysis.isPdfByHeader ? 'success' : 'error';
            log(`PDFå¤´éƒ¨æ£€æŸ¥: ${pdfStatus}`, pdfColor);

            // æœåŠ¡å™¨å“åº”æ¨¡æ‹Ÿ
            analysis.serverSimulation = simulateServerBehavior(file, uint8Array);
            log(`æœåŠ¡å™¨MIMEç±»å‹æ¨¡æ‹Ÿ: ${analysis.serverSimulation.simulatedMimeType}`, 'warning');
            log(`æ¨èContent-Type: ${analysis.serverSimulation.recommendedContentType}`, 'info');

            return analysis;
        }

        // è·å–åå…­è¿›åˆ¶å¤´éƒ¨
        function getHexHeader(uint8Array, length) {
            let hex = '';
            for (let i = 0; i < Math.min(length, uint8Array.length); i++) {
                hex += uint8Array[i].toString(16).padStart(2, '0').toUpperCase() + ' ';
                if ((i + 1) % 8 === 0) hex += '\n';
            }
            return hex.trim();
        }

        // è·å–ASCIIé¢„è§ˆ
        function getAsciiPreview(uint8Array, length) {
            let preview = '';
            for (let i = 0; i < Math.min(length, uint8Array.length); i++) {
                const char = uint8Array[i];
                if (char >= 32 && char <= 126) {
                    preview += String.fromCharCode(char);
                } else {
                    preview += '.';
                }
            }
            return preview;
        }

        // æ£€æŸ¥PDFå¤´éƒ¨
        function checkPdfHeader(uint8Array) {
            const pdfSignature = [0x25, 0x50, 0x44, 0x46, 0x2D]; // %PDF-
            if (uint8Array.length < pdfSignature.length) return false;
            
            for (let i = 0; i < pdfSignature.length; i++) {
                if (uint8Array[i] !== pdfSignature[i]) {
                    return false;
                }
            }
            return true;
        }

        // æ¨¡æ‹ŸæœåŠ¡å™¨è¡Œä¸º
        function simulateServerBehavior(file, uint8Array) {
            const result = {
                simulatedMimeType: 'application/zip', // æ¨¡æ‹Ÿé”™è¯¯çš„æœåŠ¡å™¨è¡Œä¸º
                recommendedContentType: 'application/pdf',
                reason: 'æœåŠ¡å™¨é…ç½®é”™è¯¯ï¼Œå°†PDFè¯†åˆ«ä¸ºZIP'
            };

            // åŸºäºæ–‡ä»¶å†…å®¹ç»™å‡ºæ­£ç¡®çš„Content-Typeå»ºè®®
            if (checkPdfHeader(uint8Array)) {
                result.recommendedContentType = 'application/pdf';
                result.reason = 'æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„PDFç­¾å';
            } else if (file.name.toLowerCase().endsWith('.pdf')) {
                result.recommendedContentType = 'application/pdf';
                result.reason = 'åŸºäºæ–‡ä»¶æ‰©å±•åæ¨æ–­';
            }

            return result;
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ†æç»“æœ
        function displayFileAnalysis(analysis) {
            const container = document.getElementById('fileDetails');
            const card = document.createElement('div');
            card.className = 'detail-card';
            
            const statusClass = analysis.isPdfByHeader ? 'status-ok' : 'status-error';
            const statusText = analysis.isPdfByHeader ? 'æœ‰æ•ˆPDF' : 'éPDFæ–‡ä»¶';
            
            card.innerHTML = `
                <div class="detail-title">
                    <span class="status-indicator ${statusClass}"></span>
                    ${analysis.name}
                </div>
                <div class="detail-content">
                    <p><strong>çŠ¶æ€:</strong> ${statusText}</p>
                    <p><strong>å¤§å°:</strong> ${(analysis.size / 1024).toFixed(2)} KB</p>
                    <p><strong>MIMEç±»å‹:</strong> ${analysis.mimeType || 'æœªæŒ‡å®š'}</p>
                    <p><strong>æœåŠ¡å™¨æ¨¡æ‹Ÿ:</strong> ${analysis.serverSimulation.simulatedMimeType}</p>
                    <p><strong>å»ºè®®ä¿®æ­£:</strong> ${analysis.serverSimulation.recommendedContentType}</p>
                    <details>
                        <summary>åå…­è¿›åˆ¶å¤´éƒ¨</summary>
                        <div class="hex-view">${analysis.hexHeader}</div>
                    </details>
                </div>
            `;
            
            container.appendChild(card);
        }

        // æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”æµ‹è¯•
        function simulateServerResponse() {
            if (analyzedFiles.length === 0) {
                log('è¯·å…ˆåˆ†ææ–‡ä»¶', 'error');
                return;
            }

            log('=== æœåŠ¡å™¨å“åº”æ¨¡æ‹Ÿæµ‹è¯• ===', 'info');
            
            analyzedFiles.forEach((file, index) => {
                log(`æ–‡ä»¶ ${index + 1}: ${file.name}`, 'info');
                log(`  å½“å‰MIMEç±»å‹: ${file.mimeType}`, 'warning');
                log(`  æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”: ${file.serverSimulation.simulatedMimeType}`, 'error');
                log(`  åº”è¯¥è¿”å›: ${file.serverSimulation.recommendedContentType}`, 'success');
                log(`  é—®é¢˜åŸå› : ${file.serverSimulation.reason}`, 'debug');
                log('---', 'info');
            });

            log('å»ºè®®è§£å†³æ–¹æ¡ˆ:', 'success');
            log('1. æ£€æŸ¥WebæœåŠ¡å™¨çš„MIMEç±»å‹é…ç½®', 'info');
            log('2. ç¡®ä¿.pdfæ‰©å±•åæ˜ å°„åˆ°application/pdf', 'info');
            log('3. åœ¨nginxä¸­æ·»åŠ : application/pdf pdf;', 'info');
            log('4. åœ¨Apacheä¸­æ·»åŠ : AddType application/pdf .pdf', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”¬ PDFæ–‡ä»¶ç±»å‹æ·±åº¦åˆ†æå·¥å…·å·²å¯åŠ¨', 'success');
            log('è¯·ä¸Šä¼ PDFæ–‡ä»¶è¿›è¡Œè¯¦ç»†åˆ†æ', 'info');
            log('æ­¤å·¥å…·å°†å¸®åŠ©æ‚¨è¯Šæ–­MIMEç±»å‹è¯†åˆ«é—®é¢˜', 'info');
        });
    </script>
</body>
</html>