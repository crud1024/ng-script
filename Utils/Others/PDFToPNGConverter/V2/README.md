# 批量文件转PNG转换器 V2

## 功能介绍

这是一个增强版的批量文件转换工具，支持将多种格式的文件转换为PNG图片格式。

### 支持的文件格式

- **PDF文件** - 转换每一页为单独的PNG图片
- **图片文件** - JPG、PNG、GIF、BMP等格式转换为PNG
- **Word文档** - DOC、DOCX格式（简化处理）
- **PPT文档** - PPT、PPTX格式（简化处理）  
- **Excel文档** - XLS、XLSX格式（简化处理）
- **ZIP文件** - 压缩包格式（简化处理）

### 主要特性

- 🔄 批量处理多个文件
- 🎯 多层次文件类型识别（MIME类型 + 文件名 + 内容检测）
- 💾 支持自定义水印
- 📊 实时进度显示
- 🌐 基于浏览器的客户端处理
- ⚡ 智能库加载（按需加载PDF.js）
- 🔍 智能容错机制（解决服务器MIME类型错误问题）

## 常见问题及解决方案

### ❗ "不支持的文件类型: application/zip" 错误

这是最常见的问题，**根本原因**是Web服务器错误地将PDF文件识别为ZIP文件。

#### 问题分析
```
错误信息: Error: 不支持的文件类型: application/zip
实际状况: 文件扩展名是.pdf，但服务器返回Content-Type: application/zip
```

#### 解决方案

**方案一：使用增强版转换器（推荐）**
新版转换器已内置智能容错机制：
- 自动检测文件内容判断真实格式
- 即使MIME类型错误也能正确处理PDF
- 多层次验证确保准确性

**方案二：修复服务器配置**
```nginx
# Nginx配置
location ~* \.pdf$ {
    add_header Content-Type application/pdf;
}

# 或在mime.types中确保
application/pdf pdf;
```

```apache
# Apache配置
AddType application/pdf .pdf
```

**方案三：使用调试工具诊断**
打开 `advanced-debug.html` 进行详细分析：
- 上传问题文件查看真实内容
- 分析MIME类型和文件头信息
- 获取服务器配置建议

### 使用方法

#### 基本用法

```javascript
// 创建转换器实例
const converter = new BatchPDFToPNGConverter({
    dataList: [
        {
            u_cert_name_level: "文件ID",
            u_zwmc: "文件名.pdf", 
            u_zswj: "文件标识"
        }
    ],
    logo: "水印文字",
    baseUrl: "https://your-domain.com",
    scale: 2.0  // PDF渲染缩放比例
});
```

### 配置选项

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `dataList` | Array | `[]` | 待转换的文件数据列表 |
| `logo` | String | `""` | 水印文字 |
| `baseUrl` | String | `window.location.origin` | 基础URL |
| `scale` | Number | `2.0` | PDF渲染缩放比例 |

### 数据格式

每个数据项应包含以下字段：

```javascript
{
    u_cert_name_level: "唯一标识符",  // 必填
    u_zwmc: "文件名",               // 必填
    u_zswj: "文件关联ID"            // 必填
}
```

## 文件类型处理说明

### PDF文件
- 使用PDF.js库进行解析
- 每页生成一张PNG图片
- 支持自定义渲染质量
- **智能检测**：即使MIME类型不正确，也会通过文件内容检测确认
- **容错处理**：自动处理服务器配置错误导致的类型识别问题

### 图片文件
- 直接转换为PNG格式
- 保持原始尺寸
- 支持常见图片格式

### Office文档
- Word/PPT/Excel文档生成占位图片
- 显示文档类型标识
- 如需完整转换，建议集成专业转换库

### ZIP文件
- 生成ZIP文件类型的占位图片
- 如需解压处理，建议集成JSZip等库

## 调试和诊断工具

### 1. advanced-debug.html（推荐）
**专业级调试工具**，提供：
- 🔍 文件内容深度分析
- 📊 十六进制头部查看
- 🌐 服务器响应模拟
- 📝 详细的诊断报告
- 💡 服务器配置建议

### 2. debug.html
**基础调试工具**，适合：
- 快速文件类型检测
- 简单场景测试
- 基础问题排查

### 3. example.html
**使用示例**，展示：
- 标准使用方法
- 各种文件格式处理
- 完整的功能演示

## 技术细节

### 智能文件识别流程
1. **第一层**：检查MIME类型
2. **第二层**：验证文件扩展名
3. **第三层**：深度内容检测（读取文件头）
4. **第四层**：智能容错处理

### PDF内容检测机制
```javascript
// 检测PDF文件头签名
const pdfSignature = [0x25, 0x50, 0x44, 0x46, 0x2D]; // %PDF-
// 同时检查PDF对象结构特征
```

### 容错处理策略
- MIME类型与文件名冲突时优先信任文件名
- ZIP类型但文件名含.pdf时进行二次验证
- 未知类型时尝试内容检测作为最后手段

## 注意事项

1. **浏览器兼容性**：需要现代浏览器支持Canvas和Fetch API
2. **文件大小限制**：大文件可能影响性能
3. **Office文档**：当前版本对Office文档的处理较为简化
4. **网络请求**：需要能够访问指定的文件URL
5. **MIME类型**：服务器返回的MIME类型可能不准确，现已添加多重检测机制

## 更新日志

### V2.2 增强版（最新）
- ✅ **智能容错机制**：解决PDF被错误识别为ZIP的问题
- ✅ **增强内容检测**：更准确的文件类型识别
- ✅ **专业调试工具**：advanced-debug.html提供深度分析
- ✅ **多层次验证**：MIME+扩展名+内容三重检测
- ✅ **详细日志记录**：便于问题诊断和追踪

### V2.1 增强版
- ✅ 新增ZIP文件支持
- ✅ 文件内容深度检测
- ✅ 添加基础调试工具
- ✅ 改进文件类型识别算法

### V2.0 增强版
- ✅ 新增多格式文件支持
- ✅ 智能文件类型识别
- ✅ 按需加载PDF.js库
- ✅ 改进的错误处理机制

### V1.0 基础版
- ✅ 基础PDF转PNG功能
- ✅ 批量处理支持
- ✅ 进度显示功能