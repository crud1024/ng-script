<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç±»å‹è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .file-info {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #3367d6;
        }
        .log {
            background: #000;
            color: #00ff00;
            border: 1px solid #333;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #44ff44;
        }
        .warning {
            color: #ffff44;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ–‡ä»¶ç±»å‹è°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <h2>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip" multiple>
        <button onclick="analyzeFiles()">åˆ†æé€‰ä¸­æ–‡ä»¶</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="container">
        <h2>æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•</h2>
        <button onclick="testPdfScenario()">æ¨¡æ‹ŸPDFåœºæ™¯</button>
        <button onclick="testZipScenario()">æ¨¡æ‹ŸZIPåœºæ™¯</button>
        <button onclick="testMixedScenario()">æ¨¡æ‹Ÿæ··åˆåœºæ™¯</button>
    </div>

    <div class="log" id="logOutput"></div>

    <!-- å¼•å…¥è½¬æ¢å™¨ -->
    <script src="./BatchP2P.js"></script>
    
    <script>
        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function log(message, type = '') {
            const logElement = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? `class="${type}"` : '';
            logElement.innerHTML += `<div ${className}>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }

        // åˆ†æä¸Šä¼ çš„æ–‡ä»¶
        function analyzeFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                log('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            log('=== æ–‡ä»¶åˆ†æå¼€å§‹ ===', 'success');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                log(`--- æ–‡ä»¶ ${i + 1} ---`);
                log(`æ–‡ä»¶å: ${file.name}`);
                log(`æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(2)} KB`);
                log(`MIMEç±»å‹: ${file.type}`);
                
                // æ£€æµ‹æ–‡ä»¶ç±»å‹
                const detectedType = detectFileType(file);
                log(`æ£€æµ‹åˆ°çš„ç±»å‹: ${detectedType}`, detectedType === 'unknown' ? 'error' : 'success');
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºPDF
                checkIfPdf(file);
            }
            
            log('=== æ–‡ä»¶åˆ†æå®Œæˆ ===', 'success');
        }

        // æ£€æµ‹æ–‡ä»¶ç±»å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function detectFileType(file) {
            const mimeType = file.type.toLowerCase();
            const fileName = file.name.toLowerCase();
            
            // PDFæ£€æµ‹
            if (mimeType.includes('pdf') || fileName.includes('.pdf')) {
                return 'pdf';
            }
            
            // ZIPæ£€æµ‹
            if (mimeType.includes('zip') || fileName.includes('.zip')) {
                return 'zip';
            }
            
            // å›¾ç‰‡æ£€æµ‹
            if (mimeType.startsWith('image/')) {
                return 'image';
            }
            
            // Wordæ£€æµ‹
            if (mimeType.includes('word') || fileName.includes('.doc') || fileName.includes('.docx')) {
                return 'word';
            }
            
            // PPTæ£€æµ‹
            if (mimeType.includes('powerpoint') || fileName.includes('.ppt') || fileName.includes('.pptx')) {
                return 'powerpoint';
            }
            
            // Excelæ£€æµ‹
            if (mimeType.includes('excel') || fileName.includes('.xls') || fileName.includes('.xlsx')) {
                return 'excel';
            }
            
            return 'unknown';
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºPDFæ–‡ä»¶
        function checkIfPdf(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                const pdfHeader = '%PDF-';
                
                let isPdf = true;
                for (let i = 0; i < Math.min(pdfHeader.length, uint8Array.length); i++) {
                    if (uint8Array[i] !== pdfHeader.charCodeAt(i)) {
                        isPdf = false;
                        break;
                    }
                }
                
                if (isPdf) {
                    log('âœ… é€šè¿‡å†…å®¹æ£€æµ‹ç¡®è®¤ä¸ºPDFæ–‡ä»¶', 'success');
                } else {
                    log('âŒ å†…å®¹æ£€æµ‹ä¸åŒ¹é…PDFæ ¼å¼', 'error');
                    // æ˜¾ç¤ºæ–‡ä»¶å¤´ä¿¡æ¯
                    let headerStr = '';
                    for (let i = 0; i < Math.min(10, uint8Array.length); i++) {
                        headerStr += String.fromCharCode(uint8Array[i]);
                    }
                    log(`æ–‡ä»¶å¤´å†…å®¹: "${headerStr}"`, 'warning');
                }
            };
            
            reader.onerror = function() {
                log('âŒ æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            
            // åªè¯»å–å‰1024å­—èŠ‚è¿›è¡Œæ£€æµ‹
            reader.readAsArrayBuffer(file.slice(0, 1024));
        }

        // æ¨¡æ‹ŸPDFåœºæ™¯
        function testPdfScenario() {
            log('=== æ¨¡æ‹ŸPDFåœºæ™¯æµ‹è¯• ===', 'success');
            
            const testData = [{
                u_cert_name_level: "TEST_PDF_001",
                u_zwmc: "æµ‹è¯•æ–‡æ¡£.pdf",
                u_zswj: "test_pdf_001"
            }];
            
            try {
                new BatchPDFToPNGConverter({
                    dataList: testData,
                    logo: "æµ‹è¯•æ°´å°",
                    baseUrl: window.location.origin
                });
                log('âœ… PDFåœºæ™¯æµ‹è¯•å¯åŠ¨æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ PDFåœºæ™¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹ŸZIPåœºæ™¯
        function testZipScenario() {
            log('=== æ¨¡æ‹ŸZIPåœºæ™¯æµ‹è¯• ===', 'success');
            
            const testData = [{
                u_cert_name_level: "TEST_ZIP_001",
                u_zwmc: "æµ‹è¯•æ–‡ä»¶.zip",
                u_zswj: "test_zip_001"
            }];
            
            try {
                new BatchPDFToPNGConverter({
                    dataList: testData,
                    logo: "æµ‹è¯•æ°´å°",
                    baseUrl: window.location.origin
                });
                log('âœ… ZIPåœºæ™¯æµ‹è¯•å¯åŠ¨æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ ZIPåœºæ™¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹Ÿæ··åˆåœºæ™¯
        function testMixedScenario() {
            log('=== æ¨¡æ‹Ÿæ··åˆåœºæ™¯æµ‹è¯• ===', 'success');
            
            const testData = [
                {
                    u_cert_name_level: "MIXED_001",
                    u_zwmc: "PDFæ–‡æ¡£.pdf",
                    u_zswj: "mixed_001"
                },
                {
                    u_cert_name_level: "MIXED_002",
                    u_zwmc: "å‹ç¼©æ–‡ä»¶.zip",
                    u_zswj: "mixed_002"
                }
            ];
            
            try {
                new BatchPDFToPNGConverter({
                    dataList: testData,
                    logo: "æ··åˆæµ‹è¯•æ°´å°",
                    baseUrl: window.location.origin
                });
                log('âœ… æ··åˆåœºæ™¯æµ‹è¯•å¯åŠ¨æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ æ··åˆåœºæ™¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ æ–‡ä»¶ç±»å‹è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
            log('ğŸ’¡ è¯·ä¸Šä¼ æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œæˆ–ç‚¹å‡»æŒ‰é’®è¿›è¡Œåœºæ™¯æµ‹è¯•');
            log('ğŸ“‹ æ­¤å·¥å…·å¯ä»¥å¸®åŠ©è¯Šæ–­æ–‡ä»¶ç±»å‹è¯†åˆ«é—®é¢˜');
        });
    </script>
</body>
</html>